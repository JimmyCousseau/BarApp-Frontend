<div class="container-global">
    <div class="container">
        <mat-card class="mat-card">
            <mat-tab-group mat-align-tabs="start" mat-stretch-tabs="false" fitInkBarToContent="true">
                <mat-tab label="Informations personnelles">
                    <form (ngSubmit)="changePassword()" [formGroup]="newPasswordForm" autocomplete="off">
                        <mat-card-title class="mat-card-title">Changer de mot de passe</mat-card-title>
                        <div style="display: grid; justify-content: space-evenly;">

                            <mat-card-content>
                                <mat-form-field appearance="outline">
                                    <mat-label>Ancien mot de passe</mat-label>
                                    <input matInput type="password" formControlName="oldPassword" />
                                </mat-form-field>

                                <mat-form-field appearance="outline" class="mat-form-field">
                                    <mat-label>Nouveau mot de passe</mat-label>
                                    <input matInput type="password" formControlName="newPassword" />
                                    <mat-error> {{getErrorMessage(newPasswordForm)}} </mat-error>
                                </mat-form-field>
                            </mat-card-content>

                            <mat-card-content style="justify-content: normal">
                                <button type="submit" mat-raised-button class="primary-color">Valider</button>
                            </mat-card-content>
                        </div>
                    </form>
                    <qrcode [qrdata]="'{{currentIp}}'" [width]="256" [errorCorrectionLevel]="'M'">
                    </qrcode>
                </mat-tab>
                <mat-tab label="Administration" *ngIf="canAccessAdminPanel()">
                    <mat-tab-group mat-align-tabs="start" mat-stretch-tabs="false">
                        <mat-tab label="Utilisateurs & Rôles">
                            <form (ngSubmit)="openDialog(passwordVerification, addUser, null)" [formGroup]="newUserForm"
                                autocomplete="off" class="mat-form">

                                <mat-card-title class="mat-card-title">
                                    Ajouter un utilisateur
                                </mat-card-title>

                                <div style="display: grid; justify-content: space-evenly;">
                                    <mat-card-content>
                                        <mat-form-field appearance="outline">
                                            <mat-label>Nom de l'utilisateur</mat-label>
                                            <input matInput formControlName="username" type="text" />
                                            <mat-error>
                                                {{getErrorMessage(newUserForm)}}
                                            </mat-error>
                                        </mat-form-field>
                                    </mat-card-content>
                                    <mat-card-content>
                                        <mat-form-field appearance="outline">
                                            <mat-label>Rôle de l'utilisateur</mat-label>
                                            <mat-select formControlName="role">
                                                <mat-option class="mat-option" *ngFor="let role of roleList"
                                                    [value]="role.role">
                                                    {{role.role}}
                                                </mat-option>
                                            </mat-select>
                                        </mat-form-field>
                                    </mat-card-content>

                                    <mat-card-content>
                                        <button type="submit" mat-raised-button class="primary-color">
                                            Ajouter l'utilisateur
                                        </button>
                                    </mat-card-content>

                                </div>
                            </form>

                            <mat-divider class="mat-divider"></mat-divider>

                            <mat-card-title class="mat-card-title">
                                Modifier un utilisateur
                            </mat-card-title>

                            <div style="display: grid; justify-content: space-evenly;">
                                <table mat-table [dataSource]="dataUsers" class="mat-elevation-z8 styled-table1">

                                    <ng-container matColumnDef="name">
                                        <th mat-header-cell *matHeaderCellDef> Nom d'utilisateur </th>
                                        <td mat-cell *matCellDef="let user"> {{user.username}} </td>
                                    </ng-container>

                                    <ng-container matColumnDef="role">
                                        <th mat-header-cell *matHeaderCellDef> Rôle </th>
                                        <td mat-cell *matCellDef="let user">
                                            <mat-form-field appearance="outline">
                                                <mat-select [(value)]="user.role"
                                                    (selectionChange)="openDialog(passwordVerification, changeUsersRole, [user])">
                                                    <mat-option class="mat-option" *ngFor="let role of roleList"
                                                        [value]="role.role">
                                                        {{role.role}}
                                                    </mat-option>
                                                </mat-select>
                                            </mat-form-field>
                                        </td>
                                    </ng-container>

                                    <ng-container matColumnDef="actions">
                                        <th mat-header-cell *matHeaderCellDef> Actions </th>
                                        <td mat-cell *matCellDef="let user">
                                            <button mat-raised-button
                                                (click)="openDialog(passwordVerification, deleteUser, [user.username, user.role])">
                                                <mat-icon>delete</mat-icon>
                                            </button>
                                        </td>
                                    </ng-container>

                                    <tr mat-header-row *matHeaderRowDef="['name', 'role', 'actions']"></tr>
                                    <tr mat-row *matRowDef="let user; columns: ['name', 'role', 'actions'];"></tr>

                                </table>
                            </div>

                            <mat-divider class="mat-divider"></mat-divider>

                            <mat-card-title class="mat-card-title">
                                Ajouter un rôles
                            </mat-card-title>

                            <mat-card-content class="mat-card-content">
                                <div style="display: grid; justify-content: space-evenly;">
                                    <form class="mat-form" [formGroup]="newRoleForm"
                                        (ngSubmit)="openDialog(passwordVerification, addRole, [])">
                                        <mat-form-field appearance="outline">
                                            <mat-label>Nom du rôle</mat-label>
                                            <input matInput type="text" formControlName="role" />
                                        </mat-form-field>
                                        <mat-error style="margin-bottom:10px">
                                            {{getErrorMessage(newRoleForm)}}
                                        </mat-error>
                                        <button mat-raised-button class="primary-color" type="submit">
                                            Ajouter le rôle
                                        </button>
                                    </form>
                                </div>
                            </mat-card-content>

                            <mat-divider class="mat-divider"></mat-divider>

                            <mat-card-title class="mat-card-title">
                                Modifier un rôle
                            </mat-card-title>

                            <mat-card-content class="role-list-btn">
                                <div *ngFor="let role of roleList">
                                    <button mat-raised-button (click)="openDialog(modifyRolePermissions, null, role )">
                                        {{role.role}}
                                    </button>
                                </div>
                            </mat-card-content>

                        </mat-tab>

                        <mat-tab label="Produits">

                            <mat-card-title class="mat-card-title">
                                Labels
                            </mat-card-title>

                            <mat-card-content class="role-list-btn">
                                <div *ngFor="let label of labels">
                                    <button mat-raised-button (click)="openDialog(labelDialog, null, label )">
                                        {{label.label}}
                                    </button>
                                </div>
                            </mat-card-content>

                            <button mat-raised-button class="primary-color"
                                (click)="openDialog(labelDialog, null, null)">
                                +
                            </button>

                            <mat-divider></mat-divider>

                            <mat-card-title class="mat-card-title">
                                Stocks
                            </mat-card-title>

                            <button mat-raised-button class="primary-color"
                                (click)="openDialog(productDialog, null, null)">
                                Ajouter un produit au stock
                            </button>

                            <div style="display: grid; justify-content: space-evenly;">
                                <table mat-table matSort [dataSource]="dataProducts"
                                    class="mat-elevation-z8 styled-table1" (matSortChange)="sortData($event)">

                                    <ng-container matColumnDef="name">
                                        <th mat-header-cell mat-sort-header="name" *matHeaderCellDef> Intitulé </th>
                                        <td mat-cell *matCellDef="let product"> {{product.name}} </td>
                                    </ng-container>

                                    <ng-container matColumnDef="amount">
                                        <th mat-header-cell mat-sort-header="amount" *matHeaderCellDef> Quantité </th>
                                        <td mat-cell *matCellDef="let product"> {{product.amount}} </td>
                                    </ng-container>

                                    <tr mat-header-row *matHeaderRowDef="['name', 'amount']"></tr>
                                    <tr mat-row *matRowDef="let product; columns: ['name', 'amount']"
                                        (click)="openDialog(productDialog, null, product)"></tr>

                                </table>
                                <mat-paginator [pageSizeOptions]="[10, 15, 25, 50]" showFirstLastButtons
                                    aria-label="Select page of products">
                                </mat-paginator>
                            </div>
                        </mat-tab>
                    </mat-tab-group>
                </mat-tab>

            </mat-tab-group>
        </mat-card>
    </div>
</div>

<ng-template #passwordVerification let-data>
    <app-password-template [dataSource]="data"></app-password-template>
</ng-template>

<ng-template #modifyRolePermissions let-data>
    <app-modify-role-template [dataSource]="data"></app-modify-role-template>
</ng-template>

<ng-template #productDialog let-data>
    <product-form [dataSource]="data"></product-form>
</ng-template>

<ng-template #labelDialog let-data>
    <app-label-template [dataSource]="data"></app-label-template>
</ng-template>
